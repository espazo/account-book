<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hiring</title>

    <style>
        table,
        #control {
            margin: auto;
        }

        #control {
            width: 50%;
        }

        table {
            clear: both;
        }

        table tr {
            border-bottom: 1px lightgray solid;
            display: block;
        }

        table tr td,
        th {
            width: 200px;
            text-align: center;
        }
    </style>
</head>

<body>

    <form id="control">
        <span>
            年份：
            <select id="sel-year">
                <option value="all">全部</option>
            </select>
        </span>
        <span>
            月份：
            <select id="sel-month">
                <option value="all">全部</option>
            </select>
        </span>
        <span>
            类型：
            <select id="sel-type">
                <option value="all">全部</option>
            </select>
        </span>
        <span style="float: right;">
            <input type="button" value="添加记录">
        </span>
    </form>

    <table>
        <tr>
            <th>类型</th>
            <th>时间</th>
            <th>分类</th>
            <th>金额</th>
        </tr>
        <tbody id="content">
        </tbody>
    </table>

</body>
<script>
    const log = console.log.bind(console);

    const e = function (selectors) {
        return document.querySelector(selectors);
    }

    const account_category = function (id = '', type = 0, name = '') {
        return {
            'id': id,
            'type': type,
            'name': name,
        }
    }

    const account = function (type = 0, time = 0, category = '', amount = .0) {

        const get_time = function () {
            const year = time.getFullYear();
            const month = time.getMonth() + 1;
            const day = time.getDate();

            return year + '/' + month + '/' + day;
        }

        const get_type = function () {
            if (type == 1) {
                return '收入';
            } else if (type == 0) {
                return '支出';
            } else {
                return '数据有误：' + type;
            }
        }

        const get_category = function () {
            for (let i = 0; i < table_category.length; i++) {
                if (category === table_category[i].id) {
                    return table_category[i].name;
                }
            }
            return '数据有误' + category;
        }

        return {
            'type': get_type,
            'time': get_time,
            'category': get_category,
            'amount': amount,
        }
    }

    const table = []
    const table_category = []

    const show_table = function () {
        const tbody = e('#content');
        for (let i = 0; i < table.length; i++) {

            const tr = document.createElement('tr');
            for (let j = 0; j < 4; j++) {
                tr.appendChild(document.createElement('td'));
            }

            tr.children[0].innerHTML = table[i].type();
            tr.children[1].innerHTML = table[i].time();
            tr.children[2].innerHTML = table[i].category();
            tr.children[3].innerHTML = table[i].amount;

            tbody.appendChild(tr);
        }
    }

    const get_category = function () {
        let url = 'https://raw.githubusercontent.com/xmindltd/hiring/master/frontend-1/categories.csv';
        fetch(url, {
            method: 'GET',
        }).then(function (res) {
            return res.text();
        }).then(function (res) {
            res = res.split('\n');
            for (let i = 1; i < res.length; i++) {
                const row = res[i].split(',');

                const id = row[0];
                const type = parseInt(row[1]);
                const name = row[2];

                table_category.push(account_category(id, type, name));
            }

            get_data();
        });
    }

    const get_data = function () {
        let url = 'https://raw.githubusercontent.com/xmindltd/hiring/master/frontend-1/bill.csv';
        fetch(url, {
            method: 'GET',
        }).then(function (res) {
            return res.text();
        }).then(function (res) {
            res = res.split('\n');
            for (let i = 1; i < res.length; i++) {
                const row = res[i].split(',')

                const type = parseInt(row[0]);
                const time = new Date(parseInt(row[1]));
                const category = row[2];
                const amount = parseInt(row[3]);

                table.push(account(type, time, category, amount));
            }

            show_table();
        });
    }

    const test = function () {
        const sel_year = e('#sel-year');
        sel_year.value = 'saab';

        const option = document.createElement("option");
        option.value = "test-value";
        option.text = "option-text";
        sel_year.appendChild(option);

        const sel = document.createElement("select");
        sel_year.onchange = function (e) {
            log(e.srcElement.id);
        }

        log(sel_year.value);
    }

    const __main = function () {
        test();
        get_category();
    }

    __main();
</script>

</html>